{"ast":null,"code":"const express = require('express');\nconst {\n  getDatabase\n} = require('../config/database');\nconst {\n  authenticateToken\n} = require('../middleware/auth');\nconst router = express.Router();\nconsole.log('üìÅ –ê—Ä—Ö–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...');\n\n// –ó–∞–ø—É—Å–∫ —Ç–µ—Ö–Ω–∏–∫–∏ (–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ)\nrouter.post('/launch/:id', authenticateToken, (req, res) => {\n  const db = getDatabase();\n  const {\n    id\n  } = req.params;\n  const {\n    completion_reason = 'launched'\n  } = req.body;\n  console.log(`üöÄ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∏ ${id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${req.user.username}`);\n\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞\n  if (req.user.role !== 'admin' && req.user.role !== 'dispatcher') {\n    return res.status(403).json({\n      message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞'\n    });\n  }\n\n  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è\n  db.get('SELECT * FROM equipment WHERE id = ?', [id], (err, equipment) => {\n    if (err) {\n      console.error('Error fetching equipment:', err);\n      return res.status(500).json({\n        message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è'\n      });\n    }\n    if (!equipment) {\n      return res.status(404).json({\n        message: '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'\n      });\n    }\n\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å (—Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤–æ–µ –∏–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ)\n    if (equipment.status !== 'ready' && equipment.status !== 'scheduled') {\n      return res.status(400).json({\n        message: '–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤–æ–µ –∏–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'\n      });\n    }\n\n    // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é\n    db.serialize(() => {\n      db.run('BEGIN TRANSACTION');\n\n      // –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n      const archiveQuery = `\n                INSERT INTO equipment_archive \n                (id, type, model, status, priority, planned_start, planned_end, \n                 actual_start, actual_end, delay_hours, malfunction, mechanic_name, \n                 progress, created_at, updated_at, completed_date, completion_user, \n                 archive_reason, original_table)\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, \n                        CURRENT_TIMESTAMP, ?, ?, 'equipment')\n            `;\n      db.run(archiveQuery, [equipment.id, equipment.type, equipment.model, 'launched', equipment.priority, equipment.planned_start, equipment.planned_end, equipment.actual_start, equipment.actual_end, equipment.delay_hours, equipment.malfunction, equipment.mechanic_name, equipment.progress, equipment.created_at, equipment.updated_at, req.user.userId, completion_reason], function (archiveErr) {\n        if (archiveErr) {\n          db.run('ROLLBACK');\n          console.error('Error archiving equipment:', archiveErr);\n          return res.status(500).json({\n            message: '–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è'\n          });\n        }\n\n        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é\n        db.run('INSERT INTO equipment_history (equipment_id, user_id, action, new_value) VALUES (?, ?, ?, ?)', [id, req.user.userId, 'launch', '–¢–µ—Ö–Ω–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É'], function (historyErr) {\n          if (historyErr) {\n            console.error('Error logging launch:', historyErr);\n          }\n\n          // –£–¥–∞–ª—è–µ–º –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã\n          db.run('DELETE FROM equipment WHERE id = ?', [id], function (deleteErr) {\n            if (deleteErr) {\n              db.run('ROLLBACK');\n              console.error('Error deleting equipment:', deleteErr);\n              return res.status(500).json({\n                message: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è'\n              });\n            }\n\n            // –ö–æ–º–º–∏—Ç–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é\n            db.run('COMMIT', function (commitErr) {\n              if (commitErr) {\n                console.error('Error committing transaction:', commitErr);\n                return res.status(500).json({\n                  message: '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π'\n                });\n              }\n              console.log(`‚úÖ –¢–µ—Ö–Ω–∏–∫–∞ ${id} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É`);\n              res.json({\n                message: `–¢–µ—Ö–Ω–∏–∫–∞ ${id} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É`,\n                equipment: equipment,\n                archived: true\n              });\n            });\n          });\n        });\n      });\n    });\n  });\n});\n\n// –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π\nrouter.get('/', authenticateToken, (req, res) => {\n  const db = getDatabase();\n  const {\n    page = 1,\n    limit = 20,\n    start_date,\n    end_date,\n    type,\n    mechanic,\n    archive_reason\n  } = req.query;\n  let query = 'SELECT * FROM equipment_archive WHERE 1=1';\n  let params = [];\n\n  // –§–∏–ª—å—Ç—Ä—ã\n  if (start_date) {\n    query += ' AND DATE(completed_date) >= ?';\n    params.push(start_date);\n  }\n  if (end_date) {\n    query += ' AND DATE(completed_date) <= ?';\n    params.push(end_date);\n  }\n  if (type) {\n    query += ' AND type = ?';\n    params.push(type);\n  }\n  if (mechanic) {\n    query += ' AND mechanic_name LIKE ?';\n    params.push(`%${mechanic}%`);\n  }\n  if (archive_reason) {\n    query += ' AND archive_reason = ?';\n    params.push(archive_reason);\n  }\n\n  // –ü–∞–≥–∏–Ω–∞—Ü–∏—è\n  const offset = (page - 1) * limit;\n  query += ' ORDER BY completed_date DESC LIMIT ? OFFSET ?';\n  params.push(parseInt(limit), parseInt(offset));\n  console.log(`üìã –ó–∞–ø—Ä–æ—Å –∞—Ä—Ö–∏–≤–∞: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${page}, –ª–∏–º–∏—Ç ${limit}`);\n  db.all(query, params, (err, archives) => {\n    if (err) {\n      console.error('Error fetching archives:', err);\n      return res.status(500).json({\n        message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö'\n      });\n    }\n\n    // –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\n    let countQuery = 'SELECT COUNT(*) as total FROM equipment_archive WHERE 1=1';\n    let countParams = [];\n    if (start_date) {\n      countQuery += ' AND DATE(completed_date) >= ?';\n      countParams.push(start_date);\n    }\n    if (end_date) {\n      countQuery += ' AND DATE(completed_date) <= ?';\n      countParams.push(end_date);\n    }\n    if (type) {\n      countQuery += ' AND type = ?';\n      countParams.push(type);\n    }\n    if (mechanic) {\n      countQuery += ' AND mechanic_name LIKE ?';\n      countParams.push(`%${mechanic}%`);\n    }\n    if (archive_reason) {\n      countQuery += ' AND archive_reason = ?';\n      countParams.push(archive_reason);\n    }\n    db.get(countQuery, countParams, (countErr, countResult) => {\n      if (countErr) {\n        console.error('Error counting archives:', countErr);\n        return res.status(500).json({\n          message: '–û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–ø–∏—Å–µ–π'\n        });\n      }\n      res.json({\n        archives: archives || [],\n        pagination: {\n          page: parseInt(page),\n          limit: parseInt(limit),\n          total: countResult ? countResult.total : 0,\n          pages: countResult ? Math.ceil(countResult.total / limit) : 0\n        }\n      });\n    });\n  });\n});\n\n// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞—Ä—Ö–∏–≤–∞\nrouter.get('/stats', authenticateToken, (req, res) => {\n  const db = getDatabase();\n  const {\n    start_date,\n    end_date\n  } = req.query;\n  console.log('üìä –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞—Ä—Ö–∏–≤–∞');\n\n  // –ü–æ–ª—É—á–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n  let totalQuery = `\n        SELECT \n            COUNT(*) as total_archived,\n            COUNT(CASE WHEN archive_reason = 'launched' THEN 1 END) as launched,\n            COUNT(CASE WHEN archive_reason = 'completed' THEN 1 END) as completed,\n            COUNT(CASE WHEN archive_reason = 'cancelled' THEN 1 END) as cancelled\n        FROM equipment_archive \n        WHERE 1=1\n    `;\n  let totalParams = [];\n  if (start_date) {\n    totalQuery += ' AND DATE(completed_date) >= ?';\n    totalParams.push(start_date);\n  }\n  if (end_date) {\n    totalQuery += ' AND DATE(completed_date) <= ?';\n    totalParams.push(end_date);\n  }\n  db.get(totalQuery, totalParams, (totalErr, totalStats) => {\n    if (totalErr) {\n      console.error('Error fetching total stats:', totalErr);\n      return res.status(500).json({\n        message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏'\n      });\n    }\n    console.log('üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä—Ö–∏–≤–∞ –ø–æ–ª—É—á–µ–Ω–∞:', totalStats);\n\n    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n    res.json({\n      summary: totalStats || {\n        total_archived: 0,\n        launched: 0,\n        completed: 0,\n        cancelled: 0\n      }\n    });\n  });\n});\nconsole.log('‚úÖ –ê—Ä—Ö–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');\nmodule.exports = router;","map":{"version":3,"names":["express","require","getDatabase","authenticateToken","router","Router","console","log","post","req","res","db","id","params","completion_reason","body","user","username","role","status","json","message","get","err","equipment","error","serialize","run","archiveQuery","type","model","priority","planned_start","planned_end","actual_start","actual_end","delay_hours","malfunction","mechanic_name","progress","created_at","updated_at","userId","archiveErr","historyErr","deleteErr","commitErr","archived","page","limit","start_date","end_date","mechanic","archive_reason","query","push","offset","parseInt","all","archives","countQuery","countParams","countErr","countResult","pagination","total","pages","Math","ceil","totalQuery","totalParams","totalErr","totalStats","summary","total_archived","launched","completed","cancelled","module","exports"],"sources":["C:/Users/kassymzhan.nuraliyev/OneDrive - KAZ Minerals Management LLP/Desktop/Tablo/Tablo/frontend/src/components/archive.js"],"sourcesContent":["const express = require('express');\r\nconst { getDatabase } = require('../config/database');\r\nconst { authenticateToken } = require('../middleware/auth');\r\n\r\nconst router = express.Router();\r\n\r\nconsole.log('üìÅ –ê—Ä—Ö–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...');\r\n\r\n// –ó–∞–ø—É—Å–∫ —Ç–µ—Ö–Ω–∏–∫–∏ (–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ)\r\nrouter.post('/launch/:id', authenticateToken, (req, res) => {\r\n    const db = getDatabase();\r\n    const { id } = req.params;\r\n    const { completion_reason = 'launched' } = req.body;\r\n\r\n    console.log(`üöÄ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∏ ${id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${req.user.username}`);\r\n\r\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞\r\n    if (req.user.role !== 'admin' && req.user.role !== 'dispatcher') {\r\n        return res.status(403).json({ message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞' });\r\n    }\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è\r\n    db.get('SELECT * FROM equipment WHERE id = ?', [id], (err, equipment) => {\r\n        if (err) {\r\n            console.error('Error fetching equipment:', err);\r\n            return res.status(500).json({ message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è' });\r\n        }\r\n\r\n        if (!equipment) {\r\n            return res.status(404).json({ message: '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });\r\n        }\r\n\r\n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å (—Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤–æ–µ –∏–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ)\r\n        if (equipment.status !== 'ready' && equipment.status !== 'scheduled') {\r\n            return res.status(400).json({\r\n                message: '–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤–æ–µ –∏–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'\r\n            });\r\n        }\r\n\r\n        // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é\r\n        db.serialize(() => {\r\n            db.run('BEGIN TRANSACTION');\r\n\r\n            // –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\r\n            const archiveQuery = `\r\n                INSERT INTO equipment_archive \r\n                (id, type, model, status, priority, planned_start, planned_end, \r\n                 actual_start, actual_end, delay_hours, malfunction, mechanic_name, \r\n                 progress, created_at, updated_at, completed_date, completion_user, \r\n                 archive_reason, original_table)\r\n                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, \r\n                        CURRENT_TIMESTAMP, ?, ?, 'equipment')\r\n            `;\r\n\r\n            db.run(archiveQuery, [\r\n                equipment.id, equipment.type, equipment.model, 'launched', equipment.priority,\r\n                equipment.planned_start, equipment.planned_end, equipment.actual_start,\r\n                equipment.actual_end, equipment.delay_hours, equipment.malfunction,\r\n                equipment.mechanic_name, equipment.progress, equipment.created_at,\r\n                equipment.updated_at, req.user.userId, completion_reason\r\n            ], function (archiveErr) {\r\n                if (archiveErr) {\r\n                    db.run('ROLLBACK');\r\n                    console.error('Error archiving equipment:', archiveErr);\r\n                    return res.status(500).json({ message: '–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è' });\r\n                }\r\n\r\n                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é\r\n                db.run(\r\n                    'INSERT INTO equipment_history (equipment_id, user_id, action, new_value) VALUES (?, ?, ?, ?)',\r\n                    [id, req.user.userId, 'launch', '–¢–µ—Ö–Ω–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É'],\r\n                    function (historyErr) {\r\n                        if (historyErr) {\r\n                            console.error('Error logging launch:', historyErr);\r\n                        }\r\n\r\n                        // –£–¥–∞–ª—è–µ–º –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã\r\n                        db.run('DELETE FROM equipment WHERE id = ?', [id], function (deleteErr) {\r\n                            if (deleteErr) {\r\n                                db.run('ROLLBACK');\r\n                                console.error('Error deleting equipment:', deleteErr);\r\n                                return res.status(500).json({ message: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è' });\r\n                            }\r\n\r\n                            // –ö–æ–º–º–∏—Ç–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é\r\n                            db.run('COMMIT', function (commitErr) {\r\n                                if (commitErr) {\r\n                                    console.error('Error committing transaction:', commitErr);\r\n                                    return res.status(500).json({ message: '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π' });\r\n                                }\r\n\r\n                                console.log(`‚úÖ –¢–µ—Ö–Ω–∏–∫–∞ ${id} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É`);\r\n                                res.json({\r\n                                    message: `–¢–µ—Ö–Ω–∏–∫–∞ ${id} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ä–∞–±–æ—Ç—É`,\r\n                                    equipment: equipment,\r\n                                    archived: true\r\n                                });\r\n                            });\r\n                        });\r\n                    }\r\n                );\r\n            });\r\n        });\r\n    });\r\n});\r\n\r\n// –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π\r\nrouter.get('/', authenticateToken, (req, res) => {\r\n    const db = getDatabase();\r\n    const {\r\n        page = 1,\r\n        limit = 20,\r\n        start_date,\r\n        end_date,\r\n        type,\r\n        mechanic,\r\n        archive_reason\r\n    } = req.query;\r\n\r\n    let query = 'SELECT * FROM equipment_archive WHERE 1=1';\r\n    let params = [];\r\n\r\n    // –§–∏–ª—å—Ç—Ä—ã\r\n    if (start_date) {\r\n        query += ' AND DATE(completed_date) >= ?';\r\n        params.push(start_date);\r\n    }\r\n\r\n    if (end_date) {\r\n        query += ' AND DATE(completed_date) <= ?';\r\n        params.push(end_date);\r\n    }\r\n\r\n    if (type) {\r\n        query += ' AND type = ?';\r\n        params.push(type);\r\n    }\r\n\r\n    if (mechanic) {\r\n        query += ' AND mechanic_name LIKE ?';\r\n        params.push(`%${mechanic}%`);\r\n    }\r\n\r\n\r\n    if (archive_reason) {\r\n        query += ' AND archive_reason = ?';\r\n        params.push(archive_reason);\r\n    }\r\n\r\n    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è\r\n    const offset = (page - 1) * limit;\r\n    query += ' ORDER BY completed_date DESC LIMIT ? OFFSET ?';\r\n    params.push(parseInt(limit), parseInt(offset));\r\n\r\n    console.log(`üìã –ó–∞–ø—Ä–æ—Å –∞—Ä—Ö–∏–≤–∞: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${page}, –ª–∏–º–∏—Ç ${limit}`);\r\n\r\n    db.all(query, params, (err, archives) => {\r\n        if (err) {\r\n            console.error('Error fetching archives:', err);\r\n            return res.status(500).json({ message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö' });\r\n        }\r\n\r\n        // –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏\r\n        let countQuery = 'SELECT COUNT(*) as total FROM equipment_archive WHERE 1=1';\r\n        let countParams = [];\r\n\r\n        if (start_date) {\r\n            countQuery += ' AND DATE(completed_date) >= ?';\r\n            countParams.push(start_date);\r\n        }\r\n\r\n        if (end_date) {\r\n            countQuery += ' AND DATE(completed_date) <= ?';\r\n            countParams.push(end_date);\r\n        }\r\n\r\n        if (type) {\r\n            countQuery += ' AND type = ?';\r\n            countParams.push(type);\r\n        }\r\n\r\n        if (mechanic) {\r\n            countQuery += ' AND mechanic_name LIKE ?';\r\n            countParams.push(`%${mechanic}%`);\r\n        }\r\n\r\n        if (archive_reason) {\r\n            countQuery += ' AND archive_reason = ?';\r\n            countParams.push(archive_reason);\r\n        }\r\n\r\n        db.get(countQuery, countParams, (countErr, countResult) => {\r\n            if (countErr) {\r\n                console.error('Error counting archives:', countErr);\r\n                return res.status(500).json({ message: '–û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–ø–∏—Å–µ–π' });\r\n            }\r\n\r\n            res.json({\r\n                archives: archives || [],\r\n                pagination: {\r\n                    page: parseInt(page),\r\n                    limit: parseInt(limit),\r\n                    total: countResult ? countResult.total : 0,\r\n                    pages: countResult ? Math.ceil(countResult.total / limit) : 0\r\n                }\r\n            });\r\n        });\r\n    });\r\n});\r\n\r\n// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞—Ä—Ö–∏–≤–∞\r\nrouter.get('/stats', authenticateToken, (req, res) => {\r\n    const db = getDatabase();\r\n    const { start_date, end_date } = req.query;\r\n\r\n    console.log('üìä –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞—Ä—Ö–∏–≤–∞');\r\n\r\n    // –ü–æ–ª—É—á–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\r\n    let totalQuery = `\r\n        SELECT \r\n            COUNT(*) as total_archived,\r\n            COUNT(CASE WHEN archive_reason = 'launched' THEN 1 END) as launched,\r\n            COUNT(CASE WHEN archive_reason = 'completed' THEN 1 END) as completed,\r\n            COUNT(CASE WHEN archive_reason = 'cancelled' THEN 1 END) as cancelled\r\n        FROM equipment_archive \r\n        WHERE 1=1\r\n    `;\r\n    let totalParams = [];\r\n\r\n    if (start_date) {\r\n        totalQuery += ' AND DATE(completed_date) >= ?';\r\n        totalParams.push(start_date);\r\n    }\r\n\r\n    if (end_date) {\r\n        totalQuery += ' AND DATE(completed_date) <= ?';\r\n        totalParams.push(end_date);\r\n    }\r\n\r\n    db.get(totalQuery, totalParams, (totalErr, totalStats) => {\r\n        if (totalErr) {\r\n            console.error('Error fetching total stats:', totalErr);\r\n            return res.status(500).json({ message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏' });\r\n        }\r\n\r\n        console.log('üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ä—Ö–∏–≤–∞ –ø–æ–ª—É—á–µ–Ω–∞:', totalStats);\r\n\r\n        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\r\n        res.json({\r\n            summary: totalStats || {\r\n                total_archived: 0,\r\n                launched: 0,\r\n                completed: 0,\r\n                cancelled: 0\r\n            }\r\n        });\r\n    });\r\n});\r\n\r\nconsole.log('‚úÖ –ê—Ä—Ö–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');\r\n\r\nmodule.exports = router;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}